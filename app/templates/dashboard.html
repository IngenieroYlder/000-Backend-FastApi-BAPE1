<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - BAPE</title>
    <!-- Quill CSS -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
            background-color: #f0f2f5;
        }

        /* Sidebar Styling */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            color: #ecf0f1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        }

        .sidebar h2 {
            margin-top: 0;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .menu-item {
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .menu-item.active {
            background-color: #3498db;
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        .menu-item.btn-logout {
            margin-top: auto;
            background-color: #e74c3c;
            text-align: center;
        }

        .menu-item.btn-logout:hover {
            background-color: #c0392b;
            transform: none;
        }

        /* Content Area */
        .content {
            flex-grow: 1;
            padding: 2rem 3rem;
            overflow-y: auto;
        }

        /* Container Limit for large screens */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
        }

        h3 {
            color: #34495e;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-container {
            background: white;
            padding: 2rem;
            margin-bottom: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            display: block;
        }

        input,
        select,
        textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            flex: 1;
            min-width: 200px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .hidden {
            display: none !important;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th,
        td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            color: #2c3e50;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        tr:last-child td {
            border-bottom: none;
        }

        .ql-container {
            height: 150px;
            margin-bottom: 15px;
            border-radius: 0 0 6px 6px;
        }

        .ql-toolbar {
            border-radius: 6px 6px 0 0;
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <h2>BAPE Panel</h2>
        <div id="btn-products" class="menu-item active" onclick="showSection('products')">Productos</div>
        <div id="btn-services" class="menu-item" onclick="showSection('services')">Servicios</div>
        <div id="btn-categories" class="menu-item" onclick="showSection('categories')">Categorías</div>
        <div id="btn-users" class="menu-item" onclick="showSection('users')">Usuarios</div>
        <div class="menu-item btn-logout" id="logoutBtn" onclick="logout()">Cerrar Sesión</div>
    </div>

    <div class="content">
        <div class="main-container">
            <!-- Products Section -->
            <div id="productsSection">
                <h1>Gestión de Productos</h1>
                <div class="form-container">
                    <h3>Nuevo Producto</h3>
                    <form id="productForm">
                        <div class="form-row">
                            <input type="text" id="prodName" placeholder="Nombre" required>
                            <input type="number" id="prodPrice" placeholder="Precio" step="0.01" required>
                            <input type="number" id="prodStock" placeholder="Stock" required>
                        </div>
                        <div class="form-row">
                            <select id="prodCategory" required>
                                <option value="">Selecciona Categoría...</option>
                            </select>
                            <input type="text" id="prodImage" placeholder="URL Imagen Principal">
                        </div>
                        <div class="form-row">
                            <input type="text" id="prodShortDesc" placeholder="Descripción Corta">
                        </div>
                        <label>Descripción Larga (WYSIWYG):</label>
                        <div id="prodLongDescEditor"></div>
                        <label style="display:block; margin-top: 15px; margin-bottom: 5px;">Galería (URLs separadas
                            por
                            coma):</label>
                        <textarea id="prodGallery" rows="3" placeholder="http://img1.jpg, http://img2.jpg"></textarea>
                        <div style="text-align: right; margin-top: 15px;">
                            <button type="submit" class="btn btn-primary">Crear Producto</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th style="width: 100px;">Precio</th>
                                <th style="width: 80px;">Stock</th>
                                <th style="width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Services Section -->
            <div id="servicesSection" class="hidden">
                <h1>Gestión de Servicios</h1>
                <div class="form-container">
                    <h3>Nuevo Servicio</h3>
                    <form id="serviceForm">
                        <div class="form-row">
                            <input type="text" id="servName" placeholder="Nombre" required>
                            <input type="number" id="servPrice" placeholder="Precio" step="0.01" required>
                        </div>
                        <div class="form-row">
                            <select id="servCategory" required>
                                <option value="">Selecciona Categoría...</option>
                            </select>
                            <input type="text" id="servImage" placeholder="URL Imagen Principal">
                        </div>
                        <div class="form-row">
                            <input type="text" id="servShortDesc" placeholder="Descripción Corta">
                        </div>
                        <label>Descripción Larga (WYSIWYG):</label>
                        <div id="servLongDescEditor"></div>
                        <label style="display:block; margin-top: 15px; margin-bottom: 5px;">Galería (URLs separadas
                            por
                            coma):</label>
                        <textarea id="servGallery" rows="3" placeholder="http://img1.jpg, http://img2.jpg"></textarea>
                        <div style="text-align: right; margin-top: 15px;">
                            <button type="submit" class="btn btn-primary">Crear Servicio</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th>Nombre</th>
                                <th>Categoría</th>
                                <th style="width: 100px;">Precio</th>
                                <th style="width: 100px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="servicesTable"></tbody>
                    </table>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categoriesSection" class="hidden">
                <h1>Gestión de Categorías</h1>

                <div class="form-row">
                    <!-- Product Categories Column -->
                    <div
                        style="flex: 1; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                        <h4>Categorías de Productos</h4>
                        <form id="prodCatForm" style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="prodCatName" placeholder="Nueva Categoría" required>
                            <button type="submit" class="btn btn-primary">Crear</button>
                        </form>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">ID</th>
                                    <th>Nombre</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="prodCatsTable"></tbody>
                        </table>
                    </div>

                    <!-- Service Categories Column -->
                    <div
                        style="flex: 1; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                        <h4>Categorías de Servicios</h4>
                        <form id="servCatForm" style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <input type="text" id="servCatName" placeholder="Nueva Categoría" required>
                            <button type="submit" class="btn btn-primary">Crear</button>
                        </form>
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50px;">ID</th>
                                    <th>Nombre</th>
                                    <th style="width: 60px;"></th>
                                </tr>
                            </thead>
                            <tbody id="servCatsTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- Users Section -->
            <div id="usersSection" class="hidden">
                <h1>Gestión de Usuarios</h1>
                <div class="form-container">
                    <h3>Nuevo Usuario</h3>
                    <form id="userForm">
                        <div class="form-row">
                            <input type="email" id="userEmail" placeholder="Email" required>
                            <input type="password" id="userPassword" placeholder="Contraseña" required>
                            <button type="submit" class="btn btn-primary" style="flex: 0 0 100px;">Crear</button>
                        </div>
                    </form>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 50px;">ID</th>
                                <th>Email</th>
                                <th>Estado</th>
                                <th style="width: 250px;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="usersTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>



    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const token = localStorage.getItem('token');
        if (!token) window.location.href = '/login';

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/login';
        }

        var prodQuill = new Quill('#prodLongDescEditor', { theme: 'snow' });
        var servQuill = new Quill('#servLongDescEditor', { theme: 'snow' });

        function showSection(sectionId) {
            // Hide all sections
            document.getElementById('productsSection').classList.add('hidden');
            document.getElementById('servicesSection').classList.add('hidden');
            document.getElementById('categoriesSection').classList.add('hidden');
            document.getElementById('usersSection').classList.add('hidden');

            // Deactivate all menu items
            document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));

            // Show selected section and activate button
            if (sectionId === 'products') {
                document.getElementById('productsSection').classList.remove('hidden');
                document.getElementById('btn-products').classList.add('active');
                loadProdCatsDropdown('prodCategory');
                loadProducts();
            } else if (sectionId === 'services') {
                document.getElementById('servicesSection').classList.remove('hidden');
                document.getElementById('btn-services').classList.add('active');
                loadServCatsDropdown('servCategory');
                loadServices();
            } else if (sectionId === 'categories') {
                document.getElementById('categoriesSection').classList.remove('hidden');
                document.getElementById('btn-categories').classList.add('active');
                loadAllCatsList();
            } else if (sectionId === 'users') {
                document.getElementById('usersSection').classList.remove('hidden');
                document.getElementById('btn-users').classList.add('active');
                loadUsers();
            }
        }

        async function fetchAPI(url, method = 'GET', body = null) {
            const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            const response = await fetch(url, options);
            if (response.status === 401) logout();
            return response;
        }

        function parseGallery(text) {
            if (!text) return [];
            return text.split(',').map(s => s.trim()).filter(s => s);
        }

        // --- CATEGORIES ---
        async function loadAllCatsList() {
            // Product Cats
            const resP = await fetchAPI('/product-categories');
            if (resP.ok) {
                const cats = await resP.json();
                document.getElementById('prodCatsTable').innerHTML = cats.map(c => `
                <tr><td>${c.id}</td><td>${c.name}</td><td><button class="btn btn-danger" onclick="deleteProdCat(${c.id})">X</button></td></tr>
                    `).join('');
            }
            // Service Cats
            const resS = await fetchAPI('/service-categories');
            if (resS.ok) {
                const cats = await resS.json();
                document.getElementById('servCatsTable').innerHTML = cats.map(c => `
                    <tr><td>${c.id}</td><td>${c.name}</td><td><button class="btn btn-danger" onclick="deleteServCat(${c.id})">X</button></td></tr>
                        `).join('');
            }
        }

        // Product Categories Logic
        document.getElementById('prodCatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = { name: document.getElementById('prodCatName').value };
            const res = await fetchAPI('/product-categories', 'POST', data);
            if (res.ok) { e.target.reset(); loadAllCatsList(); }
        });
        async function deleteProdCat(id) {
            if (confirm('¿Seguro?')) { await fetchAPI(`/product-categories/${id}`, 'DELETE'); loadAllCatsList(); }
        }

        // Service Categories Logic
        document.getElementById('servCatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = { name: document.getElementById('servCatName').value };
            const res = await fetchAPI('/service-categories', 'POST', data);
            if (res.ok) { e.target.reset(); loadAllCatsList(); }
        });
        async function deleteServCat(id) {
            if (confirm('¿Seguro?')) { await fetchAPI(`/service-categories/${id}`, 'DELETE'); loadAllCatsList(); }
        }

        // Dropdowns Helpers
        async function loadProdCatsDropdown(selectId) {
            const res = await fetchAPI('/product-categories');
            if (res.ok) {
                const cats = await res.json();
                document.getElementById(selectId).innerHTML = '<option value="">Selecciona Categoría...</option>' +
                    cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }
        async function loadServCatsDropdown(selectId) {
            const res = await fetchAPI('/service-categories');
            if (res.ok) {
                const cats = await res.json();
                document.getElementById(selectId).innerHTML = '<option value="">Selecciona Categoría...</option>' +
                    cats.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        // --- PRODUCTS ---
        async function loadProducts() {
            const res = await fetchAPI('/products/');
            if (res.ok) {
                const products = await res.json();
                const tbody = document.getElementById('productsTable');
                tbody.innerHTML = products.map(p => `
                    <tr>
                        <td>${p.id}</td>
                        <td title="${p.name}">${p.name}</td>
                        <td>${p.category_id || '-'}</td> 
                        <td>$${p.price}</td>
                        <td>${p.stock}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteProduct(${p.id})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('prodName').value,
                price: parseFloat(document.getElementById('prodPrice').value),
                stock: parseInt(document.getElementById('prodStock').value),
                category_id: parseInt(document.getElementById('prodCategory').value),
                image: document.getElementById('prodImage').value,
                short_description: document.getElementById('prodShortDesc').value,
                long_description: prodQuill.root.innerHTML,
                gallery_images: parseGallery(document.getElementById('prodGallery').value)
            };
            data.description = data.short_description;

            const res = await fetchAPI('/products/', 'POST', data);
            if (res.ok) {
                e.target.reset();
                prodQuill.setContents([]);
                loadProducts();
            } else {
                alert('Error al crear producto');
            }
        });

        async function deleteProduct(id) {
            if (!confirm('¿Seguro?')) return;
            const res = await fetchAPI(`/products/${id}`, 'DELETE');
            if (res.ok) loadProducts();
        }

        // --- SERVICES ---
        async function loadServices() {
            const res = await fetchAPI('/services/');
            if (res.ok) {
                const services = await res.json();
                const tbody = document.getElementById('servicesTable');
                tbody.innerHTML = services.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td title="${s.name}">${s.name}</td>
                        <td>${s.category_id || '-'}</td>
                        <td>$${s.price}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteService(${s.id})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.getElementById('serviceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('servName').value,
                price: parseFloat(document.getElementById('servPrice').value),
                category_id: parseInt(document.getElementById('servCategory').value),
                image: document.getElementById('servImage').value,
                short_description: document.getElementById('servShortDesc').value,
                long_description: servQuill.root.innerHTML,
                gallery_images: parseGallery(document.getElementById('servGallery').value)
            };
            data.description = data.short_description;

            const res = await fetchAPI('/services/', 'POST', data);
            if (res.ok) {
                e.target.reset();
                servQuill.setContents([]);
                loadServices();
            } else {
                alert('Error al crear servicio');
            }
        });

        async function deleteService(id) {
            if (!confirm('¿Seguro?')) return;
            const res = await fetchAPI(`/services/${id}`, 'DELETE');
            if (res.ok) loadServices();
        }

        // --- USERS ---
        async function loadUsers() {
            const res = await fetchAPI('/users/');
            if (res.ok) {
                const users = await res.json();
                document.getElementById('usersTable').innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.email}</td>
                        <td>
                            <span style="padding: 4px 8px; border-radius: 4px; background-color: ${u.is_active ? '#d4edda' : '#f8d7da'}; color: ${u.is_active ? '#155724' : '#721c24'}; font-weight: bold;">
                                ${u.is_active ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-primary" onclick="toggleUserStatus(${u.id}, ${!u.is_active})">
                                ${u.is_active ? 'Desactivar' : 'Activar'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteUser(${u.id})">Eliminar</button>
                        </td>
                    </tr>
                `).join('');
            }
        }

        document.getElementById('userForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                email: document.getElementById('userEmail').value,
                password: document.getElementById('userPassword').value
            };

            const res = await fetchAPI('/users/', 'POST', data);
            if (res.ok) {
                e.target.reset();
                loadUsers();
            } else {
                const err = await res.json();
                alert('Error: ' + err.detail);
            }
        });

        async function toggleUserStatus(id, isActive) {
            const res = await fetchAPI(`/users/${id}/status?is_active=${isActive}`, 'PUT');
            if (res.ok) loadUsers();
        }

        async function deleteUser(id) {
            if (!confirm('¿Seguro que deseas eliminar este usuario?')) return;
            const res = await fetchAPI(`/users/${id}`, 'DELETE');
            if (res.ok) {
                loadUsers();
            } else {
                const err = await res.json();
                alert('Error: ' + err.detail);
            }
        }

        // Initial Load
        loadProducts();
    </script>
</body>

</html>
```